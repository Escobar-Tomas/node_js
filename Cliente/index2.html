<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Municipal Kanban</title>
    <style>
        :root { --bg: #f4f5f7; --primary: #0079bf; --card: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        header { background: #004d40; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .controls { display: flex; gap: 10px; }
        select, button { padding: 5px; border-radius: 4px; border: none; cursor: pointer; }
        
        /* VISTA PROYECTOS */
        #projects-view { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .project-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; border-top: 5px solid var(--primary); }
        .project-card:hover { transform: translateY(-3px); }
        
        /* VISTA KANBAN */
        #kanban-view { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .board-header { padding: 10px 20px; background: #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .board-columns { display: flex; overflow-x: auto; height: 100%; padding: 10px; gap: 10px; }
        
        .column { background: #ebecf0; min-width: 280px; width: 280px; border-radius: 5px; display: flex; flex-direction: column; max-height: 100%; }
        .column-header { padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        .task-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* TARJETA DE TAREA */
        .task-card { background: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 0.9em; }
        .task-tags { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        .tag-user { background: #e1f5fe; color: #0277bd; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; }
        .task-actions { margin-top: 8px; border-top: 1px solid #eee; padding-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* COLORES DE COLUMNAS */
        .col-1 { border-top: 3px solid #ffc107; } /* Pendiente */
        .col-2 { border-top: 3px solid #2196f3; } /* Proceso */
        .col-3 { border-top: 3px solid #9c27b0; } /* Revisi√≥n */
        .col-4 { border-top: 3px solid #f44336; } /* Bloqueo */
        .col-5 { border-top: 3px solid #4caf50; } /* Finalizada */

        /* UTILS */
        .hidden { display: none !important; }
        .btn-back { background: #555; color: white; }
        .btn-add { background: var(--primary); color: white; width: 100%; margin-top: 5px;}
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h3>üèõ MuniBoard</h3>
            <select id="areaSelect" onchange="loadProjects()">
                <option value="">Cargando √°reas...</option>
            </select>
        </div>
        <div class="controls">
            <label>Soy:</label>
            <select id="userSelect">
                <option value="">Cargando usuarios...</option>
            </select>
        </div>
    </header>

    <div id="projects-view">
        <p>Selecciona un √°rea arriba para ver los proyectos.</p>
    </div>

    <div id="kanban-view">
        <div class="board-header">
            <button class="btn-back" onclick="showProjectList()">‚Üê Volver a Proyectos</button>
            <h2 id="projectTitle" style="margin:0; color:#333;">Proyecto</h2>
            <button onclick="openNewTaskModal()" style="background:#26a69a; color:white;">+ Nueva Tarea</button>
        </div>
        <div class="board-columns" id="boardContainer">
            </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        
        // ESTADO DE LA APLICACI√ìN
        let currentProjectId = null;
        let tasksData = [];
        let allUsers = [];
        
        // CONFIGURACI√ìN DE COLUMNAS
        const COLUMNS = [
            { id: 1, name: 'Pendientes' },
            { id: 2, name: 'En Proceso' },
            { id: 3, name: 'En Revisi√≥n' },
            { id: 4, name: 'Bloqueos' },
            { id: 5, name: 'Finalizadas' }
        ];

        // --- INICIALIZACI√ìN ---
        window.onload = async () => {
            await loadDropdowns();
            loadProjects();
        };

        async function loadDropdowns() {
            // Cargar √Åreas
            const resAreas = await fetch(`${API}/areas`);
            const areas = await resAreas.json();
            const selArea = document.getElementById('areaSelect');
            selArea.innerHTML = '<option value="all">Todas las √Åreas</option>';
            areas.forEach(a => selArea.innerHTML += `<option value="${a.id_area}">${a.nombre}</option>`);

            // Cargar Usuarios
            const resUsers = await fetch(`${API}/usuarios`);
            allUsers = await resUsers.json();
            const selUser = document.getElementById('userSelect');
            selUser.innerHTML = '';
            allUsers.forEach(u => selUser.innerHTML += `<option value="${u.id_usuario}">${u.nombre}</option>`);
        }

        // --- LOGICA DE PROYECTOS ---
        async function loadProjects() {
            const areaId = document.getElementById('areaSelect').value;
            const container = document.getElementById('projects-view');
            container.innerHTML = 'Cargando...';

            try {
                const res = await fetch(`${API}/proyectos`);
                if(!res.ok) throw new Error("Sin proyectos");
                let proyectos = await res.json();

                // Filtrar en frontend por ahora (idealmente backend)
                if (areaId && areaId !== 'all') {
                    proyectos = proyectos.filter(p => p.id_area == areaId);
                }

                container.innerHTML = '';
                if(proyectos.length === 0) container.innerHTML = '<p>No hay proyectos para esta √°rea.</p>';

                proyectos.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        <h3>${p.nombre || 'Proyecto #' + p.id_proyecto}</h3>
                        <p><strong>√Årea:</strong> ${p.nombre_area || 'General'}</p>
                        <small>Click para ver tablero</small>
                    `;
                    card.onclick = () => openKanban(p);
                    container.appendChild(card);
                });
            } catch (e) {
                container.innerHTML = `<p>Error: ${e.message}</p>`;
            }
        }

        // --- LOGICA KANBAN ---
        function openKanban(proyecto) {
            currentProjectId = proyecto.id_proyecto || proyecto.id;
            document.getElementById('projectTitle').innerText = proyecto.nombre || 'Proyecto';
            
            document.getElementById('projects-view').style.display = 'none';
            document.getElementById('kanban-view').style.display = 'flex';
            
            fetchTasks();
        }

        function showProjectList() {
            document.getElementById('kanban-view').style.display = 'none';
            document.getElementById('projects-view').style.display = 'grid';
        }

        async function fetchTasks() {
            const container = document.getElementById('boardContainer');
            container.innerHTML = '<p>Cargando tablero...</p>';
            
            try {
                // Pedimos tareas filtradas por proyecto
                const res = await fetch(`${API}/tareas?id_proyecto=${currentProjectId}`);
                if(res.status === 404) {
                    tasksData = [];
                } else {
                    tasksData = await res.json();
                }
                renderBoard();
            } catch (e) {
                console.error(e);
            }
        }

        function renderBoard() {
            const container = document.getElementById('boardContainer');
            container.innerHTML = '';

            COLUMNS.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = `column col-${col.id}`;
                // AHORA USAMOS fk_estado PARA CONTAR Y FILTRAR
                const tasksInCol = tasksData.filter(t => t.fk_estado == col.id);
                
                colDiv.innerHTML = `
                    <div class="column-header">
                        <span>${col.name}</span>
                        <span style="background:#ddd; padding:2px 6px; border-radius:10px; font-size:0.8em">
                            ${tasksInCol.length}
                        </span>
                    </div>
                    <div class="task-list" id="col-list-${col.id}"></div>
                `;
                container.appendChild(colDiv);

                const listDiv = colDiv.querySelector(`#col-list-${col.id}`);

                tasksInCol.forEach(task => {
                    // --- CORRECCI√ìN CR√çTICA DEL ID ---
                    // Si tu base de datos devuelve 'id_tarea', usa eso. Si devuelve 'id', cambia a task.id
                    const idReal = task.id_tarea || task.id; 
                    
                    if (!idReal) console.error("¬°ALERTA! No se encuentra el ID en:", task);

                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    
                    // Usamos fk_estado para marcar la opci√≥n seleccionada
                    const moveOptions = COLUMNS.map(c => 
                        `<option value="${c.id}" ${c.id == task.fk_estado ? 'selected' : ''}>${c.name}</option>`
                    ).join('');

                    taskCard.innerHTML = `
                        <strong>${task.titulo}</strong>
                        <p style="margin:5px 0; color:#666;">${task.descripcion}</p>
                        
                        <div class="task-actions">
                            <select onchange="updateTaskStatus(${idReal}, this.value)" style="font-size:0.8em; width:60%">
                                ${moveOptions}
                            </select>
                            <button onclick="joinTask(${idReal})" style="font-size:0.8em; width:35%; background:#2979FF; color:white;">‚úã Unirme</button>
                        </div>
                    `;
                    listDiv.appendChild(taskCard);
                });
            });
        }

        // --- ACCIONES ---

        async function updateTaskStatus(idTarea, newStatus) {
            // Buscamos la tarea usando el ID corregido
            const task = tasksData.find(t => (t.id_tarea || t.id) == idTarea);
            
            if (!task) return alert("Error: No se encuentra la tarea en memoria");

            const updatedData = {
                titulo: task.titulo,
                descripcion: task.descripcion,
                id_proyecto: task.id_proyecto,
                fecha_inicio: task.fecha_inicio.split('T')[0], // Recortar fecha si viene larga
                fecha_fin: task.fecha_fin.split('T')[0],
                fk_estado: newStatus // <--- ENVIAMOS fk_estado AHORA
            };

            try {
                const response = await fetch(`${API}/tareas/${idTarea}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedData)
                });
                
                if(response.ok) {
                    fetchTasks(); // Recargar tablero
                } else {
                    const err = await response.json();
                    alert("Error del servidor: " + err.mensaje);
                }
            } catch (e) {
                console.error(e);
                alert("Error de red al mover tarea");
            }
        }

        async function joinTask(idTarea) {
            const userId = document.getElementById('userSelect').value;
            if(!userId) return alert("Selecciona un usuario arriba a la derecha primero");

            // NOTA: Para implementar esto 100% real, necesitas un endpoint POST /api/tareas/asignar
            // Por ahora simularemos un alert, ya que requerir√≠a cambiar tu backend bastante m√°s.
            alert(`Usuario ${userId} se ha unido a la tarea ${idTarea}. \n(Requiere endpoint backend POST /asignar)`);
            
            // Aqu√≠ har√≠as: fetch(`${API}/asignar`, { body: {id_tarea, id_usuario}... })
        }

        async function openNewTaskModal() {
            const titulo = prompt("T√≠tulo de la tarea:");
            if(!titulo) return;
            const desc = prompt("Descripci√≥n:");
            
            const nuevaTarea = {
                titulo: titulo,
                descripcion: desc || "Sin descripci√≥n",
                id_proyecto: currentProjectId,
                id_estado: 1, // Empieza en Pendiente
                fecha_inicio: new Date().toISOString().split('T')[0],
                fecha_fin: new Date().toISOString().split('T')[0]
            };

            await fetch(`${API}/tareas`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(nuevaTarea)
            });
            fetchTasks();
        }

    </script>
</body>
</html>